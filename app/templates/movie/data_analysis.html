{% extends "base.html" %} {% block title %}数据分析{% endblock %} {% block
styles %} {{ super() }}
<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  .page-title {
    text-align: center;
    color: #2c3e50;
    font-size: 2.5rem;
    margin: 30px 0;
    font-weight: 600;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
  }

  .chart-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
    padding: 25px;
    min-height: 450px;
    width: 100%;
    box-sizing: border-box;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .chart-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
  }

  .chart-title {
    font-size: 1.4rem;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eef2f7;
    color: #34495e;
    font-weight: 500;
    display: flex;
    align-items: center;
  }

  .chart-title::before {
    content: "";
    display: inline-block;
    width: 4px;
    height: 20px;
    background: #3498db;
    margin-right: 10px;
    border-radius: 2px;
  }

  .charts-grid {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin: 30px 0;
  }

  .relationship-chart {
    min-height: 600px;
  }

  .heatmap-chart {
    min-height: 500px;
  }

  .activity-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
  }

  .activity-table th,
  .activity-table td {
    border: 1px solid #eef2f7;
    padding: 12px;
    text-align: center;
    transition: background-color 0.2s ease;
  }

  .activity-table th {
    background-color: #f8fafc;
    color: #2c3e50;
    font-weight: 500;
  }

  .activity-table tr:hover td {
    background-color: #f8fafc;
  }

  .activity-cell {
    position: relative;
    transition: all 0.3s ease;
  }

  .activity-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    color: #2c3e50;
  }

  .no-data-message {
    text-align: center;
    color: #95a5a6;
    margin-top: 30px;
    font-size: 1.1rem;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
  }

  /* 自定义滚动条样式 */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .container {
      padding: 10px;
    }

    .page-title {
      font-size: 2rem;
      margin: 20px 0;
    }

    .chart-container {
      padding: 15px;
      min-height: 350px;
    }

    .chart-title {
      font-size: 1.2rem;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <h1 class="page-title">电影数据分析</h1>

  <div class="charts-grid">
    <!-- 评分分布 -->
    <div class="chart-container">
      <h3 class="chart-title">评分分布</h3>
      <canvas id="ratingDistribution"></canvas>
      <div
        id="ratingDistributionNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无评分数据
      </div>
    </div>

    <!-- 类型分布 -->
    <div class="chart-container">
      <h3 class="chart-title">电影类型分布</h3>
      <canvas id="genreDistribution"></canvas>
      <div
        id="genreDistributionNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无类型数据
      </div>
    </div>

    <!-- 年份分布 -->
    <div class="chart-container">
      <h3 class="chart-title">电影年份分布</h3>
      <canvas id="yearDistribution"></canvas>
      <div
        id="yearDistributionNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无年份数据
      </div>
    </div>

    <!-- 评分趋势 -->
    <div class="chart-container">
      <h3 class="chart-title">评分趋势</h3>
      <canvas id="ratingTrend"></canvas>
      <div id="ratingTrendNoData" class="no-data-message" style="display: none">
        暂无评分趋势数据
      </div>
    </div>

    <!-- 用户活动热力图 -->
    <div class="chart-container">
      <h3 class="chart-title">用户活动分布</h3>
      <div id="activityHeatmap"></div>
      <div
        id="activityHeatmapNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无用户活动数据
      </div>
    </div>

    <!-- 导演排行 -->
    <div class="chart-container">
      <h3 class="chart-title">top导演评分</h3>
      <canvas id="topDirectors"></canvas>
      <div
        id="topDirectorsNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无导演评分数据
      </div>
    </div>

    <!-- 电影评分热力图 -->
    <div class="chart-container heatmap-chart">
      <h3 class="chart-title">电影评分分布热力图</h3>
      <div id="ratingHeatmap" style="width: 100%; height: 500px"></div>
      <div
        id="ratingHeatmapNoData"
        class="no-data-message"
        style="display: none"
      >
        暂无评分数据
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 调试输出数据
    console.log('Rating Distribution:', {{ rating_distribution| tojson }});
  console.log('Genre Distribution:', {{ genre_distribution| tojson }});
  console.log('Year Distribution:', {{ year_distribution| tojson }});
  console.log('Rating Trend:', {{ rating_trend| tojson }});
  console.log('Activity Heatmap:', {{ activity_heatmap| tojson }});
  console.log('Top Directors:', {{ top_directors| tojson }});

  // 评分分布图
  const ratingData = {{ rating_distribution| tojson }};
  const fixedLabels = [1, 2, 3, 4, 5];
  // 构造一个评分到数量的映射
  const ratingMap = {};
  ratingData.forEach(d => {
    ratingMap[d.rating] = d.count;
  });
  // 按照固定顺序生成数据，没有的补0
  const fixedData = fixedLabels.map(rating => ratingMap[rating] || 0);

  if (ratingData && ratingData.length > 0) {
    new Chart(document.getElementById('ratingDistribution'), {
      type: 'bar',
      data: {
        labels: fixedLabels,
        datasets: [{
          label: '评分数量',
          data: fixedData,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  } else {
    document.getElementById('ratingDistributionNoData').style.display = 'block';
    document.getElementById('ratingDistribution').style.display = 'none';
  }

  // 类型分布图
  const genreData = {{ genre_distribution| tojson }};
  if (genreData && genreData.length > 0) {
    new Chart(document.getElementById('genreDistribution'), {
      type: 'pie',
      data: {
        labels: genreData.map(d => d.name),
        datasets: [{
          data: genreData.map(d => d.count),
          backgroundColor: [
            'rgba(255, 99, 132, 0.5)',
            'rgba(54, 162, 235, 0.5)',
            'rgba(255, 206, 86, 0.5)',
            'rgba(75, 192, 192, 0.5)',
            'rgba(153, 102, 255, 0.5)',
            'rgba(255, 159, 64, 0.5)'
          ]
        }]
      },
      options: {
        responsive: true
      }
    });
  } else {
    document.getElementById('genreDistributionNoData').style.display = 'block';
    document.getElementById('genreDistribution').style.display = 'none';
  }

  // 年份分布图
  const yearData = {{ year_distribution| tojson }};
  if (yearData && yearData.length > 0) {
    new Chart(document.getElementById('yearDistribution'), {
      type: 'line',
      data: {
        labels: yearData.map(d => d.year),
        datasets: [{
          label: '电影数量',
          data: yearData.map(d => d.count),
          borderColor: 'rgba(75, 192, 192, 1)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  } else {
    document.getElementById('yearDistributionNoData').style.display = 'block';
    document.getElementById('yearDistribution').style.display = 'none';
  }

  // 评分趋势图
  const trendData = {{ rating_trend| tojson }};
  if (trendData && trendData.length > 0) {
    new Chart(document.getElementById('ratingTrend'), {
      type: 'line',
      data: {
        labels: trendData.map(d => d.year),
        datasets: [{
          label: '平均评分',
          data: trendData.map(d => d.avg_rating),
          borderColor: 'rgba(255, 99, 132, 1)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            min: 0,
            max: 10
          }
        }
      }
    });
  } else {
    document.getElementById('ratingTrendNoData').style.display = 'block';
    document.getElementById('ratingTrend').style.display = 'none';
  }

  // 用户活动分布
  const activityData = {{ activity_heatmap| tojson }};
  if (activityData && activityData.length > 0) {
    const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    const hours = Array.from({ length: 24 }, (_, i) => `${i}时`);

    // 创建7x24的矩阵
    const matrix = Array(7).fill().map(() => Array(24).fill(0));
    activityData.forEach(d => {
      const dayIndex = d.day % 7;  // MySQL的DAYOFWEEK从1开始，1=周日
      matrix[dayIndex][d.hour] = d.count;
    });

    // 创建表格形式的热力图
    const container = document.getElementById('activityHeatmap');
    const table = document.createElement('table');
    table.className = 'activity-table';

    // 添加表头（小时）
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.appendChild(document.createElement('th')); // 空单元格
    hours.forEach(hour => {
      const th = document.createElement('th');
      th.textContent = hour;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // 添加数据行
    const tbody = document.createElement('tbody');
    days.forEach((day, i) => {
      const row = document.createElement('tr');
      const dayCell = document.createElement('th');
      dayCell.textContent = day;
      row.appendChild(dayCell);

      matrix[i].forEach(count => {
        const cell = document.createElement('td');
        cell.className = 'activity-cell';
        const intensity = Math.min(count / 10, 1); // 假设最大值为10
        cell.style.backgroundColor = `rgba(54, 162, 235, ${intensity})`;
        cell.textContent = count;
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  } else {
    document.getElementById('activityHeatmapNoData').style.display = 'block';
  }

  // 导演排行图
  const directorData = {{ top_directors| tojson }};
  if (directorData && directorData.length > 0) {
    new Chart(document.getElementById('topDirectors'), {
      type: 'bar',
      data: {
        labels: directorData.map(d => d.directors),
        datasets: [{
          label: '平均评分',
          data: directorData.map(d => d.avg_rating),
          backgroundColor: 'rgba(153, 102, 255, 0.5)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true,
            max: 10
          }
        }
      }
    });
  } else {
    document.getElementById('topDirectorsNoData').style.display = 'block';
    document.getElementById('topDirectors').style.display = 'none';
  }

  // 初始化评分热力图
  const heatmapChart = echarts.init(document.getElementById('ratingHeatmap'));
  fetch('/movies/api/visualizations/rating-heatmap')
    .then(response => response.json())
    .then(data => {
      console.log('Heatmap data:', data); // 添加调试日志

      if (data && data.movies && data.movies.length > 0) {
        // 确保数据格式正确
        const processedData = data.movies.map(item => {
          if (Array.isArray(item) && item.length >= 3) {
            return [item[0], item[1], parseFloat(item[2])];
          }
          return null;
        }).filter(item => item !== null);

        console.log('Processed data:', processedData); // 添加调试日志

        const option = {
          title: {
            text: '电影评分分布热力图',
            left: 'center'
          },
          tooltip: {
            position: 'top',
            formatter: function (params) {
              const cellKey = `${params.data[0]}_${params.data[1]}`;
              const details = data.details[cellKey];
              if (!details) return '';

              let content = `<div style="font-weight: bold; margin-bottom: 5px;">
                ${data.types[params.data[1]]} (${details.years[0]}-${details.years[details.years.length - 1]})
              </div>`;
              content += `<div style="margin-bottom: 5px;">平均评分: ${details.avg_rating}</div>`;
              content += '<div style="max-height: 200px; overflow-y: auto;">';
              content += '<table style="width: 100%; border-collapse: collapse;">';
              content += '<tr><th style="text-align: left; padding: 2px;">电影</th><th style="text-align: right; padding: 2px;">年份</th><th style="text-align: right; padding: 2px;">评分</th></tr>';

              details.movies.forEach(movie => {
                content += `<tr>
                  <td style="text-align: left; padding: 2px;">${movie.title}</td>
                  <td style="text-align: right; padding: 2px;">${movie.year}</td>
                  <td style="text-align: right; padding: 2px;">${movie.rating}</td>
                </tr>`;
              });

              content += '</table></div>';
              return content;
            }
          },
          grid: {
            top: '10%',
            left: '5%',
            right: '10%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            data: data.years,
            splitArea: {
              show: true
            },
            name: '年份',
            nameLocation: 'middle',
            nameGap: 30,
            axisLabel: {
              rotate: 45,
              interval: 0
            }
          },
          yAxis: {
            type: 'category',
            data: data.types,
            splitArea: {
              show: true
            },
            name: '电影类型',
            nameLocation: 'middle',
            nameGap: 50,
            axisLabel: {
              interval: 0
            }
          },
          visualMap: {
            min: 0,
            max: 10,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            bottom: '0%',
            inRange: {
              color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
            }
          },
          series: [{
            name: '电影评分',
            type: 'heatmap',
            data: processedData,
            label: {
              show: true,
              formatter: function (params) {
                return params.data[2].toFixed(1);
              }
            },
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }]
        };

        // 设置图表配置
        heatmapChart.setOption(option);

        // 添加窗口大小变化监听
        window.addEventListener('resize', function () {
          heatmapChart.resize();
        });
      } else {
        console.log('No heatmap data available'); // 添加调试日志
        document.getElementById('ratingHeatmapNoData').style.display = 'block';
        document.getElementById('ratingHeatmap').style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error loading heatmap data:', error);
      document.getElementById('ratingHeatmapNoData').style.display = 'block';
      document.getElementById('ratingHeatmap').style.display = 'none';
    });
  });
</script>
{% endblock %}
