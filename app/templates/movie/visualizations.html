{% extends "base.html" %} {% block title %}数据可视化{% endblock %} {% block
styles %}
<style>
  .chart-container {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .chart-title {
    font-size: 1.2em;
    margin-bottom: 15px;
    color: #333;
  }

  .chart-wrapper {
    position: relative;
    height: 300px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    padding: 20px;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <h1 class="my-4">电影数据可视化</h1>

  <div class="grid">
    <div class="chart-container">
      <h2 class="chart-title">评分分布</h2>
      <div class="chart-wrapper">
        <canvas id="ratingDistribution"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">类型分布</h2>
      <div class="chart-wrapper">
        <canvas id="genreDistribution"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">年份分布</h2>
      <div class="chart-wrapper">
        <canvas id="yearDistribution"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">评分趋势</h2>
      <div class="chart-wrapper">
        <canvas id="ratingTrend"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">用户活跃度分布</h2>
      <div class="chart-wrapper">
        <canvas id="activityHeatmap"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">顶级导演</h2>
      <div class="chart-wrapper">
        <canvas id="topDirectors"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 评分分布图
    fetch("/api/visualizations/rating-distribution")
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById("ratingDistribution"), {
          type: "bar",
          data: {
            labels: data.x.map((x) => x.toFixed(1) + "分"),
            datasets: [
              {
                label: "电影数量",
                data: data.y,
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "电影数量",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "评分",
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "电影评分分布",
                font: {
                  size: 16,
                },
              },
              legend: {
                display: false,
              },
            },
          },
        });
      });

    // 类型分布图
    fetch("/api/visualizations/genre-distribution")
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById("genreDistribution"), {
          type: "pie",
          data: {
            labels: data.labels,
            datasets: [
              {
                data: data.values,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.5)",
                  "rgba(54, 162, 235, 0.5)",
                  "rgba(255, 206, 86, 0.5)",
                  "rgba(75, 192, 192, 0.5)",
                  "rgba(153, 102, 255, 0.5)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      });

    // 年份分布图
    fetch("/api/visualizations/year-distribution")
      .then((response) => response.json())
      .then((data) => {
        // 按照年代对数据进行分组
        const decades = {};
        data.x.forEach((year, index) => {
          const decade = Math.floor(year / 10) * 10;
          if (!decades[decade]) {
            decades[decade] = 0;
          }
          decades[decade] += data.y[index];
        });

        const decadeLabels = Object.keys(decades).sort();
        const decadeCounts = decadeLabels.map((decade) => decades[decade]);

        new Chart(document.getElementById("yearDistribution"), {
          type: "bar",
          data: {
            labels: decadeLabels.map((d) => d + "s"),
            datasets: [
              {
                label: "电影数量",
                data: decadeCounts,
                backgroundColor: "rgba(75, 192, 192, 0.5)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "电影数量",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "年代",
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "电影年代分布",
                font: {
                  size: 16,
                },
              },
              legend: {
                display: false,
              },
            },
          },
        });
      });

    // 评分趋势图
    fetch("/api/visualizations/rating-trend")
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById("ratingTrend"), {
          type: "line",
          data: {
            labels: data.x,
            datasets: [
              {
                label: "平均评分",
                data: data.y,
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderWidth: 2,
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 5,
                title: {
                  display: true,
                  text: "平均评分",
                },
              },
              x: {
                type: "time",
                time: {
                  unit: "day",
                  displayFormats: {
                    day: "YYYY-MM-DD",
                  },
                },
                title: {
                  display: true,
                  text: "日期",
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "每日平均评分趋势",
                font: {
                  size: 16,
                },
              },
            },
          },
        });
      });

    // 用户活跃度分布图
    fetch("/api/visualizations/activity-heatmap")
      .then((response) => response.json())
      .then((data) => {
        const ctx = document.getElementById("activityHeatmap");
        const maxValue = Math.max(...data.data.map((point) => point.value));

        new Chart(ctx, {
          type: "scatter",
          data: {
            datasets: [
              {
                data: data.data.map((point) => ({
                  x: point.x,
                  y: point.y,
                  r: Math.sqrt(point.value / maxValue) * 20, // 根据活动数量调整点的大小，最大值为20
                })),
                backgroundColor: data.data.map((point) => {
                  const intensity = point.value / maxValue;
                  return `rgba(75, 192, 192, ${Math.max(0.3, intensity)})`;
                }),
                pointStyle: "circle",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                min: -1,
                max: 24,
                title: {
                  display: true,
                  text: "小时",
                },
                ticks: {
                  stepSize: 1,
                },
              },
              y: {
                min: -1,
                max: 7,
                title: {
                  display: true,
                  text: "星期",
                },
                ticks: {
                  callback: function (value) {
                    const days = [
                      "周一",
                      "周二",
                      "周三",
                      "周四",
                      "周五",
                      "周六",
                      "周日",
                    ];
                    return days[value] || "";
                  },
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "用户活动时间分布",
                font: {
                  size: 16,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const point = data.data[context.dataIndex];
                    const days = [
                      "周一",
                      "周二",
                      "周三",
                      "周四",
                      "周五",
                      "周六",
                      "周日",
                    ];
                    return `${days[point.y]} ${point.x}时: ${
                      point.value
                    }个活动`;
                  },
                },
              },
            },
          },
        });
      });

    // 顶级导演图
    fetch("/api/visualizations/top-directors")
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById("topDirectors"), {
          type: "bar",
          data: {
            labels: data.x,
            datasets: [
              {
                label: "平均评分",
                data: data.y,
                backgroundColor: "rgba(153, 102, 255, 0.5)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                title: {
                  display: true,
                  text: "平均评分",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "导演",
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "评分最高的导演",
              },
            },
          },
        });
      });
  });
</script>
{% endblock %}
