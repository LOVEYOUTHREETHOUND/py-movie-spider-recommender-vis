{% extends "base.html" %} {% block title %}{{ movie.title }} - 电影详情{%
endblock %} {% block styles %} {{ super() }}
<style>
  .movie-detail {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .movie-header {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
  }

  .movie-poster {
    flex: 0 0 300px;
  }

  .movie-poster img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .movie-info {
    flex: 1;
  }

  .movie-title {
    font-size: 24px;
    margin-bottom: 10px;
  }

  .movie-meta {
    color: #666;
    margin-bottom: 20px;
  }

  .movie-meta p {
    margin: 5px 0;
  }

  .rating-section {
    margin: 20px 0;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 8px;
  }

  .rating-form {
    margin-top: 15px;
  }

  .rating-stars {
    font-size: 24px;
    color: #ffd700;
    cursor: pointer;
  }

  .movie-summary {
    margin: 20px 0;
    line-height: 1.6;
  }

  .section-title {
    font-size: 18px;
    margin: 20px 0 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid #eee;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-4">
      <img
        src="{{ url_for('movie.movie_poster', movie_id=movie.id) }}"
        class="img-fluid rounded"
        alt="{{ movie.title }}"
      />
    </div>
    <div class="col-md-8">
      <h1 class="mb-3">{{ movie.title }}</h1>

      <div class="movie-info">
        {% if movie.original_title and movie.original_title != movie.title %}
        <p class="text-muted">原名：{{ movie.original_title }}</p>
        {% endif %}

        <div class="mb-3">
          {% if movie.year %}
          <span class="badge bg-secondary me-2">{{ movie.year }}</span>
          {% endif %} {% if movie.runtime %}
          <span class="badge bg-secondary me-2">{{ movie.runtime }}分钟</span>
          {% endif %} {% for type in movie.types %}
          <span class="badge bg-primary me-2">{{ type.name }}</span>
          {% endfor %}
        </div>

        <div class="mb-3">
          {% if movie.rating %}
          <p class="mb-2">
            <i class="fas fa-star text-warning"></i>
            <span class="ms-1">{{ "%.1f"|format(movie.rating) }}</span>
            <small class="text-muted">({{ movie.rating_count }}人评分)</small>
          </p>
          {% endif %}
        </div>

        <div class="d-flex gap-3 mb-4">
          {% if current_user.is_authenticated %}
          <button
            id="favoriteBtn"
            class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}"
            data-movie-id="{{ movie.id }}"
          >
            <i class="fas fa-heart me-1"></i>
            <span id="favoriteText"
              >{% if is_favorite %}已收藏{% else %}收藏{% endif %}</span
            >
          </button>
          {% endif %}
        </div>

        {% if movie.directors %}
        <p><strong>导演：</strong>{{ movie.directors }}</p>
        {% endif %} {% if movie.writers %}
        <p><strong>编剧：</strong>{{ movie.writers }}</p>
        {% endif %} {% if movie.actors %}
        <p><strong>主演：</strong>{{ movie.actors }}</p>
        {% endif %} {% if movie.countries %}
        <p><strong>制片国家/地区：</strong>{{ movie.countries }}</p>
        {% endif %} {% if movie.languages %}
        <p><strong>语言：</strong>{{ movie.languages }}</p>
        {% endif %} {% if movie.summary %}
        <div class="mt-4">
          <h5>剧情简介</h5>
          <p class="text-muted">{{ movie.summary }}</p>
        </div>
        {% endif %}

        <div class="rating-section mt-4">
          <h5>用户评分</h5>
          {% if current_user.is_authenticated %}
          <div class="rating-form">
            <div class="rating-stars" id="ratingStars">
              {% for i in range(5) %}
              <span class="star" data-rating="{{ i + 1 }}">★</span>
              {% endfor %}
            </div>
            <input type="hidden" id="movieId" value="{{ movie.id }}" />
            <div id="ratingMessage"></div>
          </div>
          {% else %}
          <p>请<a href="{{ url_for('auth.login') }}">登录</a>后评分</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 收藏功能
    const favoriteBtn = document.getElementById("favoriteBtn");
    if (favoriteBtn) {
      favoriteBtn.addEventListener("click", function () {
        const movieId = this.dataset.movieId;
        fetch(`/movies/favorite/${movieId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 更新按钮状态
              this.classList.toggle("btn-danger", data.is_favorite);
              this.classList.toggle("btn-outline-danger", !data.is_favorite);
              document.getElementById("favoriteText").textContent =
                data.is_favorite ? "已收藏" : "收藏";

              // 显示提示消息
              alert(data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("操作失败，请稍后重试");
          });
      });
    }

    // 评分功能代码保持不变
    const stars = document.querySelectorAll(".star");
    const movieId = document.getElementById("movieId").value;
    const messageDiv = document.getElementById("ratingMessage");
    const avgRatingSpan = document.getElementById("avgRating");
    const userRatingCountSpan = document.getElementById("userRatingCount");

    stars.forEach((star) => {
      star.addEventListener("mouseover", function () {
        const rating = this.dataset.rating;
        stars.forEach((s) => {
          if (s.dataset.rating <= rating) {
            s.style.color = "#ffd700";
          } else {
            s.style.color = "#ddd";
          }
        });
      });

      star.addEventListener("click", async function () {
        const rating = this.dataset.rating;
        try {
          const response = await fetch("/movies/rate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              movie_id: movieId,
              rating: rating,
            }),
          });

          const data = await response.json();
          if (data.success) {
            messageDiv.textContent = data.message;
            messageDiv.style.color = "green";

            // 更新星星显示
            stars.forEach((star) => {
              if (parseInt(star.dataset.rating) <= ratingValue) {
                star.classList.add("active");
                star.style.color = "#ffd700";
              } else {
                star.classList.remove("active");
                star.style.color = "#ddd";
              }
            });

            // 更新平均分显示
            if (data.data && data.data.avg_rating) {
              const systemRatingInfoDiv =
                document.getElementById("systemRatingInfo");
              if (systemRatingInfoDiv) {
                systemRatingInfoDiv.style.display = "block"; // 确保在评分后显示
              }
              avgRatingSpan.textContent = data.data.avg_rating;
              if (userRatingCountSpan) {
                userRatingCountSpan.textContent = data.data.rating_count;
              }
            }
          } else {
            messageDiv.textContent = data.message || "评分失败，请稍后重试";
            messageDiv.style.color = "red";
          }
        } catch (error) {
          console.error("Error:", error);
          messageDiv.textContent = "发生错误，请稍后重试";
          messageDiv.style.color = "red";
        }
      });
    });

    document
      .getElementById("ratingStars")
      .addEventListener("mouseleave", function () {
        stars.forEach((star) => {
          star.style.color = "#ffd700";
        });
      });
  });
</script>

<style>
  .star {
    font-size: 24px;
    color: #ffd700;
    cursor: pointer;
    margin-right: 5px;
  }

  .rating-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
  }

  #ratingMessage {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
{% endblock %}
